int lightSize = 5;
int padding = 1;
int gridWidth = 6;
int gridHeight = 6;
int curStep = 0;
int curLine = 0;
Light[][] lights;

void setup() {
  size(600, 600);
  loadState4();
}

void keyPressed() {
  if(keyCode == TAB) {
    loadState4();
  } else {
    step();
  }
}

 
void setupGrid() {
  lights = new Light[gridHeight][gridWidth];
  
  for(int i = 0; i < gridHeight; i++) {
    for(int j = 0; j < gridWidth; j++) {
      int x = j * (lightSize + padding);
      int y = i * (lightSize + padding);
      Light light = new Light(x, y);
      lights[i][j] = light;
      
      if(i > 0) {
        light.attachTo(lights[i-1][j]);
        
        if(j > 0) {
          //Diagonal up left
          light.attachTo(lights[i-1][j-1]);
        }
        if(j < gridWidth - 1) {
          //Diagonal up right
          light.attachTo(lights[i-1][j+1]);
        }
      }
      if(j > 0) {
        light.attachTo(lights[i][j-1]);
      }
    }
  }
}

void step() {
  int totalOn = 0;
  
  // All of the lights update simultaneously; they all consider the same current state before moving to the next.
  for(int i = 0; i < gridHeight; i++) {
    for(int j = 0; j < gridWidth; j++) {
      lights[j][i].updateNextState();
    }
  }
  
  for(int i = 0; i < gridHeight; i++) {
    for(int j = 0; j < gridWidth; j++) {
      lights[j][i].step();
      
      totalOn += lights[j][i].on ? 1 : 0;
    }
  } 
  
  curStep +=1;
  
  println("Step " + curStep + ": " + totalOn);
}

void draw() {
  background(0);
  
  stroke(255);
  fill(255);
  strokeWeight(0);
  
  for(int i = 0; i < gridHeight; i++) {
    for(int j = 0; j < gridWidth; j++) {
      Light l = lights[j][i];
      
      fill(l.on ? 255 : 0);
      rect(l.x, l.y, lightSize, lightSize);
      
      /* Debug Draw neighbour count
      stroke(255,0,0);
      strokeWeight(1);
      fill(122);
      text(""+l.neighbours.size(), l.x + 5, l.y+12);
      strokeWeight(0);
      */
    }
  }
  
  /* Debug Draw selected
  Light l2 = lights[3][4];
  stroke(0,255, 0);
  strokeWeight(1);
  fill(255,0.2);
  rect(l2.x, l2.y, lightSize, lightSize);
  stroke(0,0,255);
  for(Light l : l2.neighbours) {
    rect(l.x, l.y, lightSize, lightSize);
  }
  */
  
  // step();
}

void loadLine(String line) {
  for(int i = 0; i < line.length(); i++) {
    lights[curLine][i].on = (line.charAt(i) == '#'); 
  }
  
  curLine += 1;
}

void loadState1() {
  gridWidth = 6;
  gridHeight = 6;
  lightSize = 20;
  setupGrid();
  
  curStep = 0;
  curLine = 0;
  loadLine(".#.#.#");
  loadLine("...##.");
  loadLine("#....#");
  loadLine("..#...");
  loadLine("#.#..#");
  loadLine("####..");
}

void loadState2() {
  gridWidth = 100;
  gridHeight = 100;
  lightSize = 5;
  setupGrid();
  
  curStep = 0;
  curLine = 0;
  
  loadLine("#...##......#......##.##..#...##......##.#.#.###.#.#..#..#......####..#......###.#.#....#..##..###..");
  loadLine("####..#.#...#....#.#####.##.##.#..#.......#....#.##...###.###..#.#.#........#..#.#.##...##..#.####.#");
  loadLine("...#..##...#.#.###.#.###..#.##.####.###...#...........#.###..##.#.##.#.###...#.#..###....#.###.#..#.");
  loadLine(".#...##...####.#..#.....#..#...#.#.##...#...##..#.#.###....#..###.....##..#.###..###.....##..###...#");
  loadLine("..##.#####....##..#.#..##.##..######...#..###.######.....#..##...#.#..##..##..#..#..#..##.#.#.#.#...");
  loadLine(".###.###.###...##...##..###..##.###.#.....##..##.#.#########...##..##.#..##.#..##..####..#.#.#.#####");
  loadLine("#.#####..###.###.##.##.#...#.#.#.#..#.###...#..##.###.#...####.#..#.#.....###..#..####..#.#.#...##..");
  loadLine("....#...##.....#....####.##.#.###..#.#.##..#.#...##.###.###..#.##..#.#.##..##..#.##.###..#.#.###.###");
  loadLine("##.##...#.##...#.#..#.#..#...###...###.#..#..#.#####..###.#......#.....###.#####.#.#..#.#.#.##..#.#.");
  loadLine("#.#..#.....#.....##.#..##...###..##...##...###.#.###.#..#.#.###...##..##..#.###...#.#######.#...#.#.");
  loadLine("#.#.....####.#..#.##...#.##....#####.###.#.....#####....###..#........##..####...#...#.###....#..###");
  loadLine("##.#.##..#.#.##.#.....##.#.....###.####.#..######.....####.#.#..##.#.##...#..#.#.....#.####.#.......");
  loadLine("#..#..#.#..#.######.##..##.####.....##.#.##.#.######..#.#....#.#...#.#..#..#.#.###.#..#.#.#..#...###");
  loadLine("####..####.#.#.###.....#.#.#.##..#.##.##.##.#..##..##.#.##.....#.#..#.####.....###.#..#.####.#.#..##");
  loadLine("###.##..##.#.##..#..##...#.#####.##.#....##.####.#.##....#..###.#.#.##...#.....#.#.#.#.#..##.#.#..#.");
  loadLine("......#..####...##.##...#.##.##...##..#..##.###..#...#..##...#.#....###.####...#.##.###.#.##.####.##");
  loadLine("..#...#####.#.#..#.##....#..#...#..####.....###...##.###....#..#.###...#........#.#.##..#..#.#.....#");
  loadLine("#######.#.#.###.###..######.##..#####.##.###.###....####.#..##.##...###.#..############.#.##....##.#");
  loadLine("#.#...##.###.#.###..#.#.#.#.#.#..##..####.#..##.....#.##..#.##...##.#..##..#.#.#....##....##.#..#.#.");
  loadLine("..#.#.####.....###..#######.#.#.#.#...##.#####.....##...##...##.###..######.###..#...####.#..###.###");
  loadLine(".#.##....#.#.##..##.#.##.##..######...#.....#..#.#.#.#.....#.#..##.#.#.......#######....#.......#...");
  loadLine("..###.##.##..##....#.###...#.....##..##......###...##..###.##...##.###.#.#.#.###.###.#.#...###..#...");
  loadLine(".##.#.#...#...##.#.#...#..#..#.#...##.#.##...##..#....#.#..##.#..#.#..#.#.....#..#.#...#######.#.##.");
  loadLine("...####....#.###.#..###..##...##..#.#.#.###...#..##.##.##..##.#...#..#.##.....#.#........#..#.#.####");
  loadLine(".....##..###...#....#.#.#.#...###.###...#.#...#.#.####....#..####...###..#..######..##.##..###.#####");
  loadLine("#####.##..#....###.###....##.....#.#..#....#.#####.##.#.####.#.##...#..###...###..##...#.###.#####..");
  loadLine("###.##..........########.######....####.###.#..##...#.##.####.#.....##..#####..###...#####.....#.#.#");
  loadLine("##..#####.##.#.#####.#.##.##..#.##....########.#####.#...#.###.##...#.###.#.#..#....##.#..#...#.#.#.");
  loadLine(".##.#....#..#...#..#####..#..##.#......#..#....########...#..#...#.....####.#...##...#.###.#.#..##.#");
  loadLine(".##.##.#.##.#.##...#.#.#..##.##.###.#..##..#...###.##.###.#####.#.###..#..###.#...#.###.#...#..#.#.#");
  loadLine(".#..#..#.#..#..###..#....###.####.##.#.###.#.##.###.#.##.###.###...###...###.#...####...#.##.##.#.#.");
  loadLine("###..##...###...#..##.#..#.#...##....###.##.##..#####....###..#..#....#..###.###.#...#.##...#.#.#..#");
  loadLine("#....#.......##.....#.##...#..#.###.#.##..##..#.##..#.###..##.##...#####.#..#####..#####..#####....#");
  loadLine(".####.####....###..###.#.##.####.##.#...####.#.###.#.....#...####..#####.###..#.#.###.##.##...##..#.");
  loadLine("####..##...##.########...##..###..#..###.##.#.#.#........#.#####.#...#.###.####.#..####..#.#.#....##");
  loadLine("###.#..#...###.#..#..#.###...##..###.##.#.#...#..#...####..##....#.#..#..##.#.#...#####.###.#..#.#.#");
  loadLine("...##....#.###.#.#..##...##.###.#..#..#......#...#.#..####.#.##..######.####.#...#..#..#..##.#.#.##.");
  loadLine("##.####.#...#..#.#.##..##.#.#.###..##...####......#..######.#......#.##.#....##...###.#.#..#......##");
  loadLine("#.....#...#######.##.#..#.#...###.#..#.####....#.#.##.#.##...###..#...#.###.##..#.###..#.##...#####.");
  loadLine("#####.##...#..#.#.#.......#.##..#####..#####...###..##.#.#..###.#.#####.####..#.#..##...#.##...#.###");
  loadLine(".##.#..#######.###.#.####.....##...#.##.#.#..#...##....####......######.#..######.....##########.##.");
  loadLine("##...#.#..#.##.###.#.#.#.##.###.##..##.##.##...#.#..###.#######..#.....#####..#....######.#..##..###");
  loadLine(".#.#.###.....#..##..#.#..##..#.###...###.#..##...#...#.#####.#.#####..###.#..#...##..#.#..#..####...");
  loadLine(".#......##..#.....####.###....##.###.....###.##........#.###.##..#..#.#######.#.######..##..###.....");
  loadLine("..##.#.#..#.##...#.###.###...######..#..#.#..#....###.#.#....#..........#...##.##.##.#..##..#.#####.");
  loadLine("###.###.#..#.##..##.#..#..##.....##.....#..#######.#..#.#.#.####.###..###.#.#..#.##.##.####.###.####");
  loadLine("#.#.#..#....########.#..#..#...##..#.##..#.#..##..####...##.....#.##.#.#...########..#.###.#..#.#.##");
  loadLine(".##.....#...#.#...##.##....###...##..#.####...#..#.#..#..#.##..#.###.##.####.##..####.....##.#.....#");
  loadLine("....####.#.##.#.##.#..##.#.######.##.####..#...####.#..###.#.#..#..##.#.#.....##.#####.#.####...#.#.");
  loadLine("#..#####.#####.....##....######..##....#..#.#.###.#####.....##.##.####.#...##...#.##.#.#####.##.#...");
  loadLine("##.####..###.#....#...#.#.#.#.###.#####.#.####..####...####......##..#..#..#.#.##...########....#...");
  loadLine(".###.#.#.#.#..####.##.#..######..#.#.###.....#.#......#.#.#.#..####.##...##.#####.#.##..##..#..#.#..");
  loadLine(".....###...#...#.####.###.#.#.#.#.....#....#.####.###.##.##.##.#######......#.####......#....##.....");
  loadLine("##..#..#.#.##..#...#..##.##.##..###.#....##.##....####.#.##.###....#.##.#.#.##...##.###...#..#..####");
  loadLine("...#.#..##..##.#...##.##...#.#......#.#.##..###....####.##...#.#.###.#..#..#.####..##..##..#####.###");
  loadLine(".##.##..##########.##...#.##.####.#.#######.##.#.##.##..#...##....########.###..##.##.##.#..##.#.#.#");
  loadLine("#####.#....#.##..#.....#......##.##..#.##.###..##.......###..##.#.###.##.###....####.#..#.###..#.#.#");
  loadLine(".#...#..#.##....##....#...####....#...#..#...####...########.###.#..##.#.#.##..###..#.#.###.....##.#");
  loadLine("##..##.....###......#..###.##.####.##.####.#.#....#..#...#..#.#..#.###.#...#...#..##.##...#..#######");
  loadLine(".....##..###..##...#####.#.#.....###.#.#..####...#.#.#..#..####..##.#..###.####.#....##..###....#..#");
  loadLine("#.#.##.#....#.#####.#....##...#...##...##....#.#.......#....#..#...###.###.#.####..####....#.##.#.#.");
  loadLine("..##...##..###.#.#.##.#..#....#.#.....##.###.#.###.###.....#...#.#..#######.#####..#.###...##......#");
  loadLine("#......###..#....#.#..#.###.##.#...##..###.####.#.#....#.##..#.###..##.#..#####..##.###.....#..###..");
  loadLine("##.#.##..##.###.#..##.....#.##.....###....##.####.######.#...#..###....#.#...#.##.....###....#..#.#.");
  loadLine(".##.#.#.#.##..#.#.#..##..#.###.####....#..###.######..####.#.....###.##..#...###.#..######.##.#.##..");
  loadLine("...##.####.#..##.#####.##.#...##..#..#...#.#.#.#####...#....#..###...#..#....#.#.##.#.######.#..####");
  loadLine("..#.#.#.#...#.######.#.....#..#.#..###....#.#.########...#....#.#.##..#...##...#.#..#.#.###....##...");
  loadLine("#####..#..##..#..##..#..#.#.##.#....#####.####.##.#.###..##..##....#.....#.#####.#...#.#####.##.#.#.");
  loadLine("#.#..#####...####.###.###.....####.###.....##...##...#..#..#######.#.##....##..####.....##...#..#..#");
  loadLine("#.#.###.#.#..##..#....#.#...#.#.##.##..#.##.....##...#.#..##.......##.#.###..#####.#.##....#.##.....");
  loadLine("...#.......#....#.#.####.#.###.###..#....#..##.#..####........#.##..#...#.#...###.#..#.#.#...#...#..");
  loadLine("...##.#####.##.#.###.##.##.#.##..##.#.#.#.#.#.##.#..##...##.#.#..#..##.##.#####.#.###...#####..#..#.");
  loadLine("#######.#..#..#....##.#.#..####.#..#..###...#..#.......###.#.#.####....#.###...#.#.###.#.#.#.#..###.");
  loadLine("..##.##.#.##.###....###.##.#.###.#...#....#.####..###..###.#.#..#...##.#.#.#..##.###..###.#.##...###");
  loadLine("######..######..##..##.#.#.##.##.#..##..#.#.#.##..#.#...#...#.#.#..######.#..#.#.######..#......##.#");
  loadLine("#.#####.....#.......#########..###.##...#...##.#.#..#...#####...#...#..#.###.#..#.#...###.#.#.#...#.");
  loadLine("#....##....###...##.##.#...##.........##.#.#..#.#.##.#.######.#####..#..###.###.#...#.#.##.######...");
  loadLine("#.#...###.#.###.##.#.######.#######.###.##..#.#.#...######.##.####.##..#.#.#.#......##..##.........#");
  loadLine("..###..##....#.....##...#.#.###.#.#.....##.#...###.####.#...#...##..##.#.#.####..###...######....#.#");
  loadLine("..###.#.##.####.#..#.##....##..#####....#..##.##.#..#######...#.####...##.#.#.##.........#....#....#");
  loadLine(".##.#...#.####..#.#...#.##..######.##..##.#.###.##..###.###....##..#.##.##..##.#...###.##.##.###....");
  loadLine("#...###.###.#..#....#.......#..#.....###..#.###.##.##....#.####.#.####.##..##..#..#.....#....##.#.#.");
  loadLine(".##.#..#..#.##.......#.####.#######.....#.##.##.#.....#.#..#....######.#..###.##.##.....#.####..##.#");
  loadLine("###..#.###.#..####.....##....#..####....#.##.##..#...######.#########...#.#....##...###.#..#.##...#.");
  loadLine("#..###..##..#.#.##.###.#.#.##...###.#...##.##..#.###....###..#.#...#.###..######.#..#.###..#..#..#.#");
  loadLine(".#........##.#.###..###.#.#.##.....##.##.#.#...##..#.##....###..#.#.#.#.##....#.##..#.#...###...#...");
  loadLine("####.####..#....#.#.#..#..##.......##.####...###.##..#.#.##.#..##..######.......##.#.##..#...#.....#");
  loadLine("..#..#..###..##.##..######.#..###..###.#.##..##.#..#####.#.#.#.##..#.##..##.##......####.#..........");
  loadLine("...##.##..###.#...###....#.#.#.#.....#.##.....##...#...#......####...##.##....##.#..#.####.#..###.#.");
  loadLine("..#.....####.#.###.#####..#..###..#..#.#...#####...###.###....#.###..#...#..#..#.#..#.##..##.#.#....");
  loadLine("..##.#####...###.###.........#....##.####.##..#.#..#.#...#...##.##.##..#.#.##.########......#####...");
  loadLine("...###.#.#..#...#.###.###.......##.###.#..#.##########...#..#.#.#.##.#.###...######..#.#...###.##...");
  loadLine(".#.#.#######.#..##.##..##...#...####...#..#####.#..##...###.#.#...#.##...#......#..##.####..#.....##");
  loadLine(".##.##.#.#......#######..###.....##.#.##..###......#....####...#.###.#.##.#........#..#....##.....##");
  loadLine("#...#.###.#.##...##.####....#...#.###..#.#.....#.#....#.#.#.##...#.#..#####.#.#..#..#..#....#...####");
  loadLine(".....##...###......#####..##.##.##...##.#.#####..##...#.#.#.#.###...###.##.####..#.#..#.#..#.####.##");
  loadLine("#..#..##.#.##.#.##.#.#.#..###....###.##.#.##.#...#.#..#...#....###.#..#.#.######.#...####..#..##.#.#");
  loadLine("#..#.#..#...###.#..##.#...#...##.#......#...#..#..####..##.....#.###...#.#..#.#....#.#####.##.###...");
  loadLine("###....#.#..#.#..###..#.##......#...#..#..##.#..###..##..#..#.####..#...########..##.#.##.#.#.#...#.");
  loadLine(".#.#.##.##.###..#...#.#....#..#.##..#.#.#.#.##.##.#####...#........####..###..####.#####..#.##.#.##.");
}

void loadState3() {
  loadState1();
  lights[0][0].on = true;
  lights[0][0].locked = true;
  lights[5][0].on = true;
  lights[5][0].locked = true;
  lights[0][5].on = true;
  lights[0][5].locked = true;
  lights[5][5].on = true;
  lights[5][5].locked = true;
}

void loadState4() {
  loadState2();
  lights[0][0].on = true;
  lights[0][0].locked = true;
  lights[99][0].on = true;
  lights[99][0].locked = true;
  lights[0][99].on = true;
  lights[0][99].locked = true;
  lights[99][99].on = true;
  lights[99][99].locked = true;
}
